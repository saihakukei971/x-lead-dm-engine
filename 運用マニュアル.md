# Twitter Scraper 徹底運用マニュアル

## 目次

1. [前提条件と準備](#1-前提条件と準備)
2. [検索キーワードの設定](#2-検索キーワードの設定)
   - [Excelでの設定方法](#21-excelでの設定方法)
   - [Googleスプレッドシートでの設定方法](#22-googleスプレッドシートでの設定方法)
   - [キーワード検索の基本ルール](#23-キーワード検索の基本ルール)
3. [DMテンプレートの編集](#3-dmテンプレートの編集)
4. [スクレイピングの実行](#4-スクレイピングの実行)
   - [一括実行方法](#41-一括実行方法)
   - [個別モジュール実行方法](#42-個別モジュール実行方法)
5. [DM送信操作](#5-dm送信操作)
   - [初回テスト送信](#51-初回テスト送信)
   - [本番アカウントへの送信](#52-本番アカウントへの送信)
6. [結果の確認](#6-結果の確認)
7. [トラブルシューティング](#7-トラブルシューティング)
8. [カスタマイズ方法](#8-カスタマイズ方法)

---

## 1. 前提条件と準備

### 1.1 システム要件

- Windows PC（Windows 10以上推奨）
- Python 3.8以上がインストール済み
- インターネット接続
- Chromeブラウザ（自動インストール可能）

### 1.2 初期インストール手順

1. コマンドプロンプトを「管理者として実行」で開きます
2. 以下のコマンドでリポジトリをクローンします：
   ```
   git clone https://github.com/saihakukei971/x-lead-dm-engine.git
   cd x-lead-dm-engine
   ```

3. 必要なパッケージをインストールします：
   ```
   pip install -r requirements.txt
   ```

4. Playwrightのブラウザをインストールします：
   ```
   python -m playwright install chromium
   ```

### 1.3 Twitterアカウント準備

- 操作用Twitterアカウントのログイン情報を手元に用意してください
- 二段階認証を使用している場合は、認証アプリまたは電話を用意してください
- **重要**: 初回実行時は必ずテスト用アカウント（自分の別アカウントなど）を用意してください

---

## 2. 検索キーワードの設定

Twitter Scraperでは、検索キーワードをCSVファイルで管理します。このファイルには検索条件を詳細に指定できます。

### 2.1 Excelでの設定方法

#### 2.1.1 新規ファイル作成

1. Microsoft Excelを起動します
2. 新しいブックを開きます
3. 以下の5つの列見出しを1行目（A1～E1）に入力します：
   - A1セル: `キーワード1`（必須）
   - B1セル: `キーワード2`（オプション）
   - C1セル: `キーワード3`（オプション）
   - D1セル: `演算子`（"AND"または"OR"を入力）
   - E1セル: `メモ`（オプション）

#### 2.1.2 検索条件の入力

4. 2行目以降に検索条件を入力します：
   - **A列（キーワード1）**: 必ず入力してください（例：「東京」）
   - **B列（キーワード2）**: 検索を絞り込む際に入力（例：「ラーメン」）
   - **C列（キーワード3）**: さらに条件を追加する場合に入力
   - **D列（演算子）**: "AND"または"OR"を入力
     - "AND"の場合：両方のキーワードを含むツイートを検索
     - "OR"の場合：いずれかのキーワードを含むツイートを検索
   - **E列（メモ）**: 任意のメモ（例：「東京ラーメン店情報」）

5. 記入例：

| キーワード1 | キーワード2 | キーワード3 | 演算子 | メモ |
|------------|------------|------------|-------|------|
| 東京       | ラーメン    |            | AND   | 東京ラーメン店情報 |
| 大阪       | ラーメン    |            | AND   | 大阪ラーメン店情報 |
| 銀座       | グルメ      |            | OR    | 高級店情報 |
| 六本木     | バー        |            | OR    | 夜の飲食店 |
| 宮崎       | 地鶏        |            | AND   | 宮崎地鶏情報 |
| 新宿       | ランチ      |            | AND   | 新宿ランチ情報 |

#### 2.1.3 CSVとして保存

6. 「ファイル」→「名前を付けて保存」をクリックします
7. 保存先を `twitter_scraper/config` フォルダに指定します
   - フォルダが存在しない場合は作成してください
8. ファイル名を `keywords.csv` と入力します
9. 「ファイルの種類」で「CSV (カンマ区切り) (*.csv)」を選択します
10. 「保存」ボタンをクリックします
11. 文字コードの警告が表示された場合は「はい」をクリックします

### 2.2 Googleスプレッドシートでの設定方法

#### 2.2.1 新規スプレッドシート作成

1. Webブラウザで Google ドライブにログインします
2. 「新規」→「Google スプレッドシート」をクリックします
3. 以下の5つの列見出しを1行目（A1～E1）に入力します：
   - A1セル: `キーワード1`（必須）
   - B1セル: `キーワード2`（オプション）
   - C1セル: `キーワード3`（オプション）
   - D1セル: `演算子`（"AND"または"OR"を入力）
   - E1セル: `メモ`（オプション）

#### 2.2.2 検索条件の入力

4. Excelと同様に検索条件を入力します（[上記の例表](#212-検索条件の入力)を参照）

#### 2.2.3 CSVとしてダウンロード

5. 「ファイル」→「ダウンロード」→「カンマ区切りの値(.csv、現在のシート)」を選択します
6. ダウンロードしたCSVファイルを `twitter_scraper/config` フォルダに `keywords.csv` として配置します

### 2.3 キーワード検索の基本ルール

#### 2.3.1 AND検索の詳細

- D列に「AND」と入力すると、キーワード1とキーワード2を**両方含む**ツイートを検索します
- Twitter検索時には「キーワード1 キーワード2」のようにスペースで区切られた形で検索されます
- 例: 「東京」AND「ラーメン」 → 「東京 ラーメン」として検索され、両方の単語を含むツイートが抽出されます

#### 2.3.2 OR検索の詳細

- D列に「OR」と入力すると、キーワード1**または**キーワード2を含むツイートを検索します
- Twitter検索時には「キーワード1 OR キーワード2」の形式で検索されます
- 例: 「銀座」OR「グルメ」 → 「銀座 OR グルメ」として検索され、どちらかの単語を含むツイートが抽出されます

#### 2.3.3 複数行の組み合わせ

- 複数の検索条件を別々の行に追加することで、多様な検索パターンを作成できます
- 各行は独立した検索クエリとして処理され、それぞれ別々の結果ファイルが生成されます
- 毎回の実行で全行の検索条件が処理されます

#### 2.3.4 ファイル名の生成ルール

AND検索とOR検索で、生成されるファイル名の形式が異なります：

- AND検索: `キーワード1+キーワード2_日付.csv`（例: `東京+ラーメン_20250512.csv`）
- OR検索: `キーワード1orキーワード2_日付.csv`（例: `銀座orグルメ_20250512.csv`）

---

## 3. DMテンプレートの編集

検索結果から抽出したアカウントにDMを送信するために、テンプレートを編集します。

### 3.1 テンプレートファイルの場所

テンプレートファイルは `dm/dm_template.txt` にあります。このファイルをテキストエディタ（メモ帳、VS Codeなど）で開きます。

### 3.2 テンプレートの編集方法

以下のプレースホルダーを活用してテンプレートを編集します：

- `<<username>>`: 対象ユーザーのTwitterユーザー名に自動的に置換されます
- `<<keyword>>`: 検索で使用したキーワードに自動的に置換されます
- `<<campaign_url>>`: 設定したキャンペーンURLにユーザー名を付加して自動的に置換されます

### 3.3 テンプレート例

```
こんにちは <<username>> 様

いつもTwitterでの素敵な投稿を拝見しています。
特に「<<keyword>>」に関する情報発信はとても参考になります。

実は弊社では、<<keyword>>に関する新しいキャンペーンを開始しており、
<<username>> 様のようなインフルエンサーの方々と協力させていただきたいと考えております。

詳細については、下記のURLからご確認いただけます。
<<campaign_url>>

ご興味がございましたら、ぜひご連絡ください。

よろしくお願いいたします。

株式会社〇〇〇〇
マーケティング部 担当：山田
```

### 3.4 テンプレート編集のポイント

- ユーザー名と検索キーワードを活用して、パーソナライズされた内容にします
- 短すぎず、長すぎない文章量にします（Twitter DMの文字数制限に注意）
- スパム的な表現は避け、相手の投稿内容に関連した自然な文面にします
- 会社名や担当者名は実際のものに変更してください

---

## 4. スクレイピングの実行

### 4.1 一括実行方法

すべての処理を順番に自動実行する方法です（初心者向け）。

#### 4.1.1 バッチファイルの実行

1. エクスプローラーで `twitter_scraper/launcher` フォルダを開きます
2. `run_all.bat` をダブルクリックして実行します
3. コマンドプロンプトウィンドウが開き、処理が開始されます

#### 4.1.2 ログイン手順

1. Chromiumブラウザが自動的に起動し、Twitterのログイン画面が表示されます
2. **重要**: 60秒以内に手動でTwitterにログインする必要があります
   - ユーザー名（またはメールアドレス）とパスワードを入力します
   - 「ログイン」ボタンをクリックします
   - 二段階認証がある場合は、認証コードを入力します

#### 4.1.3 処理の進行

3. ログイン後、以下の処理が自動的に順次実行されます：
   - 検索クエリの実行とツイートの抽出
   - アカウント情報の収集とフィルタリング
   - DMテンプレートの生成

4. すべての処理が完了すると、コンソールに以下のようなメッセージが表示されます：
   ```
   [4/4] Ready to launch DM interactive sender.
   
   Press any key to start sending DMs (manual operation required)
   ```

5. 任意のキーを押して、DM送信フェーズに進みます

### 4.2 個別モジュール実行方法

各ステップを個別に実行したい場合の方法です（上級者向け）。

#### 4.2.1 コマンドプロンプトからの実行

1. コマンドプロンプトを開きます
2. `twitter_scraper` フォルダに移動します
3. 以下のコマンドを必要に応じて順次実行します：

```bash
# キーワード検索のみ実行
python scrape/search_tweets.py

# プロフィール抽出のみ実行
python scrape/fetch_profiles.py

# DMテンプレート生成のみ実行
python dm/generate_dm_template.py

# DM送信画面起動のみ実行
python dm/dm_interactive_launcher.py
```

#### 4.2.2 個別実行のメリット

- 特定のステップだけをやり直したい場合に便利です
- エラーが発生した場合のトラブルシューティングが容易になります
- 検索結果だけを取得し、DM送信は後日行いたい場合などに適しています

---

## 5. DM送信操作

### 5.1 初回テスト送信

**重要**: 初回実行時は必ずテスト用アカウントに送信して動作確認を行ってください！

#### 5.1.1 テスト用アカウントの準備

1. 自分自身の別のTwitterアカウントや、テスト目的で作成したアカウントを用意します
2. このアカウントをDM送信の1番目の対象として設定します
   - 方法1: `input/filtered_accounts.csv` の1行目にテストアカウントの情報を追加します
   - 方法2: DMテンプレート生成後、`dm/generated/` フォルダ内の最初に処理されるファイルをテストアカウント向けのものに置き換えます

#### 5.1.2 テスト送信の実行

1. DM送信モジュールを実行します：
   ```
   python dm/dm_interactive_launcher.py
   ```

2. 最初に表示されるアカウントがテストアカウントであることを確認します
3. DMの内容を確認し、問題がなければ送信します
4. システムの動作を確認したら、次の手順で本番アカウントへの送信に進みます

### 5.2 本番アカウントへの送信

テスト送信で問題がないことを確認した後、本番アカウントへのDM送信を行います。

#### 5.2.1 DMインタラクティブモードの操作

1. DM送信モジュールが起動すると、Chromiumブラウザで対象アカウントのプロフィール画面が表示されます
2. 各アカウントでの操作手順：
   - コンソールに対象アカウントのDMテンプレートが表示されます
   - ブラウザでは自動的にプロフィールページのDMボタンがクリックされます
   - DM送信画面が表示されたら、コンソールに表示されたテンプレートをコピーします
   - DM入力欄にテキストを貼り付けます
   - 内容を確認（必要に応じて編集）します
   - 「送信」ボタンをクリックします
   - **重要**: コンソールでEnterキーを押すと次のアカウントに進みます

#### 5.2.2 送信操作のポイント

- DM送信はすべて**手動**で行われるため、内容を確認してから送信できます
- DM送信画面が表示されない場合は、そのアカウントがDMを受け付けない設定になっている可能性があります
- 送信する前に内容を編集して、より個別化したメッセージにすることも可能です
- すべてのアカウントの処理が終了すると、プログラムは自動的に終了します

---

## 6. 結果の確認

### 6.1 検索結果の確認

1. `result/` フォルダ内に以下の形式でファイルが生成されます：
   - AND検索: `キーワード1+キーワード2_日付.csv`（例: `東京+ラーメン_20250512.csv`）
   - OR検索: `キーワード1orキーワード2_日付.csv`（例: `銀座orグルメ_20250512.csv`）

2. CSVファイルには以下の情報が含まれます：
   - `username`: Twitterのユーザー名
   - `url`: プロフィールURL
   - `bio`: プロフィール文（fetch_profiles.pyで取得後）
   - `followers`: フォロワー数（fetch_profiles.pyで取得後）
   - `tweet_url`: ツイートのURL
   - `tweet_content`: ツイート本文
   - `tweeted_at`: ツイートの日時

### 6.2 フィルタリングされたアカウントの確認

1. `input/filtered_accounts.csv` ファイルに最低フォロワー数（デフォルト10,000）以上のアカウントがリストアップされます
2. フォロワー数の降順でソートされており、影響力の大きいアカウントから確認できます

### 6.3 生成されたDMの確認

1. `dm/generated/` フォルダに各アカウント向けのDMテンプレートが保存されます
   - ファイル形式: `ユーザー名_日付.txt`（例: `ramen_master_20250512.txt`）

2. `all_dms_日付.txt` ファイルには、すべてのDMがまとめて保存されます
   - このファイルは各ユーザー宛のDMを「===」区切りで一覧表示しています

### 6.4 ログの確認

1. `log/日付/日付.log` ファイルに詳細な操作ログが記録されます
2. エラーや警告がある場合は、このログファイルで確認できます

---

## 7. トラブルシューティング

### 7.1 ログインできない場合

1. 60秒の制限時間内にログインできない場合：
   - プログラムを再起動します
   - あらかじめログイン情報をクリップボードにコピーしておくと早く入力できます

2. Twitterの二段階認証が有効になっている場合：
   - 認証アプリやSMSの確認をすぐに行えるよう準備しておきます
   - スマートフォンの認証アプリを事前に開いておくと良いでしょう

3. ログイン情報が正しいことを確認：
   - パスワードやユーザー名が間違っていないか確認します
   - Twitterのアカウント状態に問題がないか確認します

### 7.2 検索結果が0件の場合

1. `keywords.csv` の内容を確認：
   - キーワードが適切に設定されているか確認します
   - 列の位置が正しいか確認します（特にエクセルから保存した場合）

2. 検索条件の調整：
   - 検索条件が狭すぎる可能性がある場合は、条件を緩めます（例：ANDをORに変更）
   - より一般的なキーワードを使用してみます

3. ログファイルでエラーメッセージを確認：
   - `log/日付/日付.log` ファイルを確認し、エラーの有無を調べます

### 7.3 DMボタンが見つからない場合

1. アカウント設定の確認：
   - そのアカウントがDMを受け付けない設定になっている可能性があります
   - フォロワーのみDMを受け付ける設定の場合、DMボタンが表示されないことがあります

2. ログファイルのエラー確認：
   - エラーメッセージを確認し、問題の特定に役立てます

3. 処理の継続：
   - 一部のアカウントでエラーが発生しても、プログラムは次のアカウントに進むため、処理全体は継続されます

### 7.4 スクレイピングが遅い場合

1. インターネット接続の確認：
   - 接続速度を確認し、安定した接続を確保します

2. 収集するツイート数の調整：
   - `scrape/search_tweets.py` の `max_tweets` 変数を小さくして、収集するツイート数を減らします

3. 同時実行するキーワード数の削減：
   - `keywords.csv` のキーワード数を減らして再実行します

---

## 8. カスタマイズ方法

### 8.1 最小フォロワー数の変更

`scrape/fetch_profiles.py` ファイルをテキストエディタで開き、以下の部分を編集します：

```python
# 変更前
scraper = TwitterProfileScraper(min_followers=10000)

# 変更後（例：5000フォロワーに設定）
scraper = TwitterProfileScraper(min_followers=5000)
```

### 8.2 キャンペーンURLの変更

`dm/generate_dm_template.py` ファイルをテキストエディタで開き、以下の部分を編集します：

```python
# 変更前
self.campaign_url = "https://example.com/campaign/"

# 変更後
self.campaign_url = "https://your-company.com/special-offer/"
```

### 8.3 収集するツイート数の変更

`scrape/search_tweets.py` ファイルの `scroll_and_collect_tweets` メソッド内を編集します：

```python
# 変更前
max_tweets = 100  # 最大収集数

# 変更後
max_tweets = 200  # 最大収集数を増やす
```

### 8.4 定期実行のスケジューリング

Windowsのタスクスケジューラを使用して定期実行する方法：

1. Windowsの「タスクスケジューラ」を開きます
2. 「基本タスクの作成」をクリックします
3. タスク名を入力（例：「Twitter Scraper Daily Run」）
4. トリガーを選択（例：「毎日」）
5. 開始時間を設定（例：午前9:00）
6. 「プログラムの開始」を選択
7. プログラムの場所に `cmd.exe` を指定
8. 引数に以下を指定：
   ```
   /c cd /d "C:\path\to\twitter_scraper\launcher" && run_all.bat
   ```
9. 「完了」をクリックします

**注意**: 定期実行の場合でも、ログイン画面での手動操作が必要なため、無人で完全自動化することはできません。実行時間に合わせて手動ログインできるよう準備してください。

---

## 9. セキュリティ注意事項

- Twitterアカウントの資格情報は、このツールに保存されません
- DMの送信は常に手動操作で行われ、自動送信は実装されていません
- Twitter利用規約を遵守する範囲で利用してください
- 企業アカウントでの使用を推奨します（個人アカウントの場合、利用制限に抵触する可能性があります）
- 短時間に大量のアクションを行うとTwitterから制限を受ける可能性があるため、適度な間隔を空けて使用してください

---

## 10. ファイル構成と目的

```
twitter_scraper/
├── config/             # 設定ファイル
│   └── keywords.csv    # 検索キーワード定義
├── input/              # 入力データ
│   └── accounts.csv    # フィルタリングされたアカウント情報
├── result/             # 検索結果
│   ├── 東京_ラーメン_20250512.csv
│   ├── 大阪_ラーメン_20250512.csv
│   ├── 銀座_グルメor六本木_バー_20250512.csv
│   └── 宮崎_パイナップルor大阪_ユニバ_20250512.csv
├── log/                # ログファイル
│   └── 20250512/
│       └── 20250512.log
├── dm/                 # DM関連モジュール
│   ├── generate_dm_template.py   # DMテンプレート生成スクリプト
│   ├── dm_interactive_launcher.py  # DM送信支援スクリプト
│   └── dm_template.txt   # DMテンプレート
├── scrape/             # スクレイピングモジュール
│   ├── search_tweets.py    # ツイート検索スクリプト
│   └── fetch_profiles.py   # プロフィール取得スクリプト
├── utils/              # ユーティリティ関数
│   ├── keyword_parser.py   # キーワード解析
│   ├── logger_setup.py     # ログ設定
│   └── filename_generator.py  # ファイル名生成
├── launcher/           # 実行スクリプト
│   └── run_all.bat     # 一括実行バッチ
├── requirements.txt    # 依存パッケージリスト
└── README.md           # プロジェクト概要
```

---

本マニュアルは Twitter Scraper の完全な運用手順を解説しています。ご不明な点がある場合は、ログファイルを確認するか、担当者にお問い合わせください。